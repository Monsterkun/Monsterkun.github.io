---
layout: post  
title: 文件包含  
date: 2019-6-1  
tag: 文件包含  

---

# 文件包含漏洞
* 文件包含常出现在PHP语言中，其实其他语言也有，不过相对于PHP就有点少

## 包含漏洞原理解析  
1、PHP包含  
PHP提供了四个包含函数：  

* include():找不到包含的文件时候指挥产生警告（E_WARNING）,脚本继续执行
* include_once()：和include函数类似，唯一区别就是如果该文件的代码已经被包含，则不会再次被包含
* require()：找不到包含的文件时候指挥产生警告（E_WARNING_ERROR）,脚本停止执行
* require_()：和require函数类似，唯一区别就是如果该文件的代码已经被包含，则不会再次被包含  

php包含中，只要包含的文件内容符合php语法，就无论这文件是什么后缀名，php包含都能解析。但是如果包含的文件内容不符合php语法，则会暴露出源码，这个适用于读取配置信息。远程包含和本地包含在这个点上没什么区别。  


php包含又分为本地包含和远程包含：  

* 本地包含：就直接访问
* 远程包含，要php.ini的配置信息中把allow_url_include=on，给开启。php是默认关闭的，开启之后，要重启web服务才能生效


文件包含漏洞利用：

（1）、读取敏感文件：  
如果目标主机文件存在，并且存在相应的权限，那么久可以读取出文件的内容。反之，则会得到一个类似于：open basedir restriction in effect. 的警告  
（2）、远程包含shell：  
如果可以远程包含，尝试写入一句话木马进去。  
（3）、本地包含配合文件上传：  
我们可以上传一张图片x.jpg，图片的内容是创建一句话木马的shell，我们直接访问图片解析不了，可以借助本地包含来解析图片内容，这样就成功利用了。  
（4）、使用PHP封装协议：  
PHP的内置协议有file://、http://、ftp://等等  
A、可以使用封装协议读取PHP文件  
http://www.xxx.com/index.php?page=php://filter/read=convert.base64-encode/resoure=config.php  
这样就可以读取出文件的源代码的base64加密的密文，进行解密就可以得到源码  
B、写入PHP文件：
使用PHP://input可以执行php语句，不过allow_urlinclude为on才可以使用  
（5）、包含apache日记文件：  
apache有两个文件：access.log(访问日记)和error（错误日记）  
我们可以访问url的时候，访问phpinfo()，这样apache就有phpinfo()的记录，那么我们就可以包含access.log文件，那我们就可以成功利用包含漏洞。  
常用<>这些符号到了日记文件就会变形，要使用绕过技术才能成功利用  
（6）、绕waf防火墙：  
这个相当于隐藏，我们把一句话写在图片上，然后用包含漏洞去访问，达到隐藏效果









2、JSP包含  
JSP包含有：静态包含和动态包含  
具体看书了解

## 安全编写包含

防护  

* 严格判断包含中的参数是否被外部可控，因为文件包含漏洞利用成功与否关键点在于被包含的文件是否能被外部控制  
* 路径限制：限制被包含的文件只能在某一文件夹内，一定要禁止目录跳转字符，如../
* 包含文件验证：验证被包含的文件是否是白名单中的一员
* 尽量不要使用动态包含，可以在需要的页面固定写好，如：include("head.php")